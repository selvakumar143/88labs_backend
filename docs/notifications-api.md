# Notifications API (Admin + Client)

All endpoints are protected with `auth:sanctum` and role middleware.
Send token header from React:

```http
Authorization: Bearer <token>
Accept: application/json
```

## 1) Admin endpoints

Base prefix: `/api/admin/notifications`

### 1.1 Get unread count
- `GET /api/admin/notifications/unread-count`

Response:
```json
{
  "status": "success",
  "unread_count": 3
}
```

### 1.2 Get unread notifications (for bell dropdown)
- `GET /api/admin/notifications/unread?per_page=10`

Response:
```json
{
  "status": "success",
  "data": {
    "current_page": 1,
    "data": [
      {
        "id": "uuid",
        "type": "App\\Notifications\\AdminActionRequiredNotification",
        "data": {
          "event_type": "wallet_topup_created",
          "title": "New Wallet Topup Request",
          "message": "Client A submitted wallet topup TOP-0003.",
          "meta": {
            "wallet_topup_id": 3,
            "request_id": "TOP-0003"
          },
          "target": "admin"
        },
        "read_at": null,
        "created_at": "2026-02-27T10:00:00.000000Z"
      }
    ]
  },
  "unread_count": 3
}
```

### 1.3 Get all notifications (view all page)
- `GET /api/admin/notifications/all?per_page=20`

### 1.4 Mark one as read
- `PUT /api/admin/notifications/{id}/read`

### 1.5 Mark all as read
- `PUT /api/admin/notifications/read-all`

---

## 2) Client endpoints

Base prefix: `/api/client/notifications`

### 2.1 Get unread count
- `GET /api/client/notifications/unread-count`

### 2.2 Get unread notifications
- `GET /api/client/notifications/unread?per_page=10`

### 2.3 Get all notifications
- `GET /api/client/notifications/all?per_page=20`

### 2.4 Mark one as read
- `PUT /api/client/notifications/{id}/read`

### 2.5 Mark all as read
- `PUT /api/client/notifications/read-all`

---

## 3) Notification events generated by backend

### Admin receives when client submits
- `ad_account_request_created`
- `wallet_topup_created`
- `top_request_created`

### Client receives when admin updates status
- `ad_account_request_status_updated`
- `wallet_topup_status_updated`
- `top_request_status_updated`

---

## 4) ReactJS integration

## 4.1 API helper (Axios)

```js
import axios from "axios";

export const api = axios.create({
  baseURL: process.env.REACT_APP_API_BASE_URL, // e.g. http://localhost:8000
});

api.interceptors.request.use((config) => {
  const token = localStorage.getItem("token");
  if (token) config.headers.Authorization = `Bearer ${token}`;
  config.headers.Accept = "application/json";
  return config;
});
```

## 4.2 Auto refresh notifications (near-instant polling)

Use polling every 5 seconds. For most admin panels this is enough.

```js
import { useEffect, useRef, useState } from "react";
import { api } from "./api";

export function useNotifications(role = "admin") {
  const [unreadCount, setUnreadCount] = useState(0);
  const [unread, setUnread] = useState([]);
  const lastCountRef = useRef(0);

  const base = role === "admin"
    ? "/api/admin/notifications"
    : "/api/client/notifications";

  const loadUnread = async () => {
    const res = await api.get(`${base}/unread`, { params: { per_page: 10 } });
    setUnread(res.data?.data?.data || []);
    setUnreadCount(res.data?.unread_count || 0);
    lastCountRef.current = res.data?.unread_count || 0;
  };

  useEffect(() => {
    let mounted = true;

    const tick = async () => {
      try {
        const res = await api.get(`${base}/unread-count`);
        const count = res.data?.unread_count || 0;

        if (!mounted) return;
        setUnreadCount(count);

        // only fetch full list when count changed
        if (count !== lastCountRef.current) {
          await loadUnread();
        }
      } catch (e) {
        // optional: handle error/log
      }
    };

    loadUnread();
    const id = setInterval(tick, 5000);

    return () => {
      mounted = false;
      clearInterval(id);
    };
  }, [base]);

  const markAsRead = async (id) => {
    await api.put(`${base}/${id}/read`);
    await loadUnread();
  };

  const markAllAsRead = async () => {
    await api.put(`${base}/read-all`);
    await loadUnread();
  };

  return { unreadCount, unread, loadUnread, markAsRead, markAllAsRead };
}
```

## 4.3 Bell click behavior
- Bell dropdown: call `GET unread`.
- Click one item: call `PUT {id}/read`, then navigate to target screen.
- "View all": call `GET all` with pagination.

---

## 5) For true instant push (real-time websockets)

If you need 100% instant without polling, enable Laravel broadcasting (Reverb/Pusher) and subscribe in React using Laravel Echo.
Current implementation is DB notifications + polling-ready endpoints.
